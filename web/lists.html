<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>WhatsApp Pro Max</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* --- CORE --- */
        :root { --bg-dark: #0f172a; --bg-glass: rgba(15, 23, 42, 0.95); --primary: #00a884; --text-main: #e9edef; --text-muted: #8696a0; --bubble-sent: #005c4b; --bubble-rec: #202c33; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: #0b141a; color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        ::-webkit-scrollbar { width: 5px; } ::-webkit-scrollbar-thumb { background: #374045; border-radius: 3px; }

        /* HOME */
        #home-view { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; }
        .session-card { background: #202c33; width: 100%; max-width: 350px; padding: 15px; border-radius: 12px; display: flex; align-items: center; gap: 15px; margin-bottom: 15px; cursor: pointer; border: 1px solid #374045; }
        
        /* APP */
        #app-view { display: none; width: 100%; height: 100%; position: relative; }
        .sidebar { width: 100%; height: 100%; display: flex; flex-direction: column; background: #111b21; }
        .app-header { height: 60px; background: #202c33; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
        .tabs { display: flex; background: #202c33; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; color: var(--text-muted); border-bottom: 3px solid transparent; font-weight: 500; cursor: pointer; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        .chat-list { flex: 1; overflow-y: auto; padding-bottom: 150px; } /* üî• Extra Padding for Scroll */
        .chat-item { display: flex; padding: 12px 15px; align-items: center; gap: 15px; border-bottom: 1px solid #222d34; cursor: pointer; }
        .chat-item:hover { background: #202c33; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; background: #6a7f8a; object-fit: cover; flex-shrink: 0; }
        
        /* CHAT WINDOW */
        #chat-window { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #0b141a; z-index: 50; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .chat-nav { height: 60px; background: #202c33; display: flex; align-items: center; padding: 0 10px; gap: 10px; }
        .messages-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); opacity: 0.95; padding-bottom: 100px; }

        /* BUBBLES */
        .msg { max-width: 80%; padding: 6px 8px; border-radius: 8px; font-size: 14.5px; position: relative; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); color: #e9edef; line-height: 1.4; word-wrap: break-word; }
        .msg.sent { align-self: flex-end; background: var(--bubble-sent); border-top-right-radius: 0; }
        .msg.rec { align-self: flex-start; background: var(--bubble-rec); border-top-left-radius: 0; }
        .sender-name { font-size: 12px; color: #aebac1; font-weight: bold; display: block; margin-bottom: 4px; }
        .time { font-size: 10px; color: rgba(255,255,255,0.6); float: right; margin: 5px 0 0 8px; }

        /* MEDIA */
        img.chat-img { max-width: 100%; border-radius: 6px; cursor: pointer; display: block; }
        video.chat-vid { max-width: 100%; border-radius: 6px; }
        .audio-player { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 8px; min-width: 200px; }
        audio { height: 35px; width: 100%; filter: invert(0.9); }
        .file-link { text-decoration: none; color: white; display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; }

        /* Lightbox */
        #lightbox { display: none; position: fixed; inset: 0; background: black; z-index: 100; align-items: center; justify-content: center; }
        #lightbox img { max-width: 100%; max-height: 100%; }
        .lb-close { position: absolute; top: 20px; left: 20px; color: white; font-size: 30px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="home-view">
        <h2 style="color:var(--primary);">ACTIVE SESSIONS</h2>
        <div id="session-list" style="width:100%;"></div>
    </div>

    <div id="app-view">
        <div class="sidebar">
            <div class="app-header">
                <span style="font-weight:bold; font-size:20px; color:#8696a0;">WhatsApp</span>
                <button onclick="location.reload()" style="background:none; border:none; color:#f15c6d;">LOGOUT</button>
            </div>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('chats')">Chats</button>
                <button class="tab-btn" onclick="switchTab('groups')">Groups</button>
                <button class="tab-btn" onclick="switchTab('channels')">Channels</button>
            </div>
            <div class="chat-list" id="chat-list-box"></div>
        </div>

        <div id="chat-window">
            <div class="chat-nav">
                <button onclick="document.getElementById('chat-window').style.transform='translateX(100%)'" style="font-size:24px; background:none; border:none; color:white;">‚Üê</button>
                <img id="header-avatar" class="avatar" src="">
                <span id="header-name" style="font-weight:bold; font-size:16px; margin-left:10px;">User</span>
            </div>
            <div class="messages-area" id="msg-box"></div>
        </div>
    </div>

    <div id="lightbox">
        <div class="lb-close" onclick="document.getElementById('lightbox').style.display='none'">√ó</div>
        <img id="lb-img" src="">
    </div>

    <script>
        // --- üü¢ DATABASE (IndexedDB) for caching ---
        const dbName="WA_Cache_DB"; let db;
        const req=indexedDB.open(dbName,1);
        req.onupgradeneeded=e=>{db=e.target.result;db.createObjectStore("media",{keyPath:"id"});};
        req.onsuccess=e=>{db=e.target.result;};
        
        function saveLocal(id,c){if(db)db.transaction(["media"],"readwrite").objectStore("media").put({id,c});}
        function getLocal(id,cb){if(!db)return cb(null);db.transaction(["media"],"readonly").objectStore("media").get(id).onsuccess=e=>cb(e.target.result?e.target.result.c:null);}

        let currentBot=null, allChats=[], activeTab='chats';

        window.onload=()=>{ loadSessions(); }

        function loadSessions() {
            fetch('/api/sessions').then(r=>r.json()).then(res=>{
                const box=document.getElementById('session-list'); box.innerHTML='';
                res.forEach(num=>{
                    box.innerHTML+=`<div class="session-card" onclick="startApp('${num}')">
                    <div style="background:#00a884;color:white;width:45px;height:45px;border-radius:50%;display:flex;align-items:center;justify-content:center;">üì±</div>
                    <div><div style="font-weight:bold;color:white;">${num}</div><div style="font-size:12px;color:#8696a0;">Tap to open</div></div></div>`;
                });
            });
        }

        function startApp(id){ currentBot=id; document.getElementById('home-view').style.display='none'; document.getElementById('app-view').style.display='block'; loadChats(); }

        async function loadChats(){
            document.getElementById('chat-list-box').innerHTML='<div style="text-align:center;padding:20px;color:#666;">Syncing...</div>';
            const res=await fetch(`/api/chats?bot_id=${currentBot}`);
            allChats=await res.json();
            renderList();
        }

        function renderList(){
            const list=document.getElementById('chat-list-box'); list.innerHTML='';
            const filtered=allChats.filter(c=>{
                if(activeTab==='groups')return c.type==='group';
                if(activeTab==='channels')return c.type==='channel';
                return c.type==='user';
            });
            filtered.forEach(c=>{
                const aid=`av_${c.id.replace(/[^a-zA-Z0-9]/g,'')}`;
                list.innerHTML+=`<div class="chat-item" onclick="openChat('${c.id}','${c.name}','${aid}')">
                <img id="${aid}" class="avatar" src="https://ui-avatars.com/api/?name=${c.name}&background=random">
                <div style="flex:1;overflow:hidden;"><div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${c.name}</div>
                <div style="font-size:13px;color:#8696a0;">${c.id}</div></div></div>`;
                fetch(`/api/avatar?bot_id=${currentBot}&chat_id=${c.id}`).then(r=>r.json()).then(d=>{if(d.url)document.getElementById(aid).src=d.url;}).catch(()=>{});
            });
        }

        function switchTab(t){ activeTab=t; document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); renderList(); }

        async function openChat(cid,name,aid){
            document.getElementById('header-name').innerText=name;
            const src=document.getElementById(aid)?document.getElementById(aid).src:`https://ui-avatars.com/api/?name=${name}`;
            document.getElementById('header-avatar').src=src;
            
            const win=document.getElementById('chat-window'); win.style.transform='translateX(0)';
            const box=document.getElementById('msg-box'); box.innerHTML='<div style="text-align:center;padding:50px;">Loading History...</div>';

            const res=await fetch(`/api/messages?bot_id=${currentBot}&chat_id=${cid}`);
            const msgs=await res.json();
            box.innerHTML='';

            msgs.forEach(m=>{
                let c='';
                const t=m.is_from_me?'sent':'rec';
                const time=new Date(m.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                const nameTag=(!m.is_from_me && m.is_group)?`<span class="sender-name">${m.sender_name}</span>`:'';

                if(m.type==='text') {
                    c=m.content;
                    renderMsg(box, t, nameTag, c, time);
                }
                else if(m.type==='image' || m.type==='audio') {
                    // üî• CACHE LOGIC: Check DB first
                    getLocal(m.message_id, (cachedData) => {
                        if(cachedData) {
                            // Found locally
                            renderMedia(box, t, nameTag, m.type, cachedData, time);
                        } else {
                            // Not found, use incoming API data & Save
                            saveLocal(m.message_id, m.content);
                            renderMedia(box, t, nameTag, m.type, m.content, time);
                        }
                    });
                }
                else if(m.type==='video') {
                     // Catbox links don't need caching base64
                     c=`<video src="${m.content}" class="chat-vid" controls></video>`;
                     renderMsg(box, t, nameTag, c, time);
                }
                else {
                     c=`<a href="${m.content}" target="_blank" class="file-link">üìÑ Document</a>`;
                     renderMsg(box, t, nameTag, c, time);
                }
            });
            setTimeout(() => box.scrollTop=box.scrollHeight, 100);
        }

        function renderMsg(box, type, nameTag, content, time) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = `${nameTag} ${content} <span class="time">${time}</span>`;
            box.appendChild(div);
        }

        function renderMedia(box, type, nameTag, mediaType, src, time) {
            let content = '';
            if(mediaType === 'image') {
                content = `<img src="${src}" class="chat-img" onclick="showLightbox(this.src)">`;
            } else {
                content = `<div class="audio-player">üé§ <audio src="${src}" controls></audio></div>`;
            }
            renderMsg(box, type, nameTag, content, time);
        }

        function showLightbox(src){ document.getElementById('lb-img').src=src; document.getElementById('lightbox').style.display='flex'; }
    </script>
</body>
</html>